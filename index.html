<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="https://motajs.github.io/homepage-tmp/favicon.ico">
<title>HTML5魔塔游戏列表</title>
<style>
body,iframe,div {margin:0;padding:0;font-family: Verdana, 微软雅黑; box-sizing: border-box;}
a {text-decoration:none;color:rgb(0, 4, 255);}
iframe {border-width:0;}
.Container {
  max-width: 96%;
  margin: 5px auto;
}

#background {position: fixed;top: 0;left: 0;z-index: -1;width: 100%;height: 100%;pointer-events: none;}

#sortTowerSelect{margin:10px;background-color:rgba(252, 252, 252, 0.6)}

.towerTab {
  background-color:rgba(252, 252, 252, 0.6);
  border-radius: 2px;
  box-sizing: border-box;
  box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.2), 0 1px 5px 0 rgba(0,0,0,.12);
} 
.towerTab:hover {
  box-shadow: 0 2px 2px 0 rgba(87, 198, 232,.74), 0 3px 1px -2px rgba(87, 198, 232,.80), 0 1px 5px 0 rgba(87, 198, 232,.72);
}
.towerTab {
  float: left;
  margin-bottom: 1%;
  margin-left: 1%;
  margin-right: 1%;
  overflow: hidden;
  position:relative;
  height: 270px;
  cursor: pointer;
  padding-bottom: 54%;
  width: 98%;
}

@media (min-width: 600px) {
  .Container {
    max-width: 95%;
  }
  .towerTab {
    padding-bottom: 27%;
    width: 48%;
  }
}

@media (min-width: 960px) {
  .Container {
    max-width: 90%;
  }
  .towerTab {
    padding-bottom: 19%;
    width: 31.333333%;
  }
}

@media (min-width: 1400px) {
  .Container {
    max-width: 85%;
  }
  .towerTab {
    width: 23%;
  }
}

.towerAuths {
  position:absolute;left:10px;bottom:10px;
}
.towerAuth {
  font-size: 16px;
  color: #6e6e6e;
}
.towerAuth2 {
  font-size: 16px;
  color: #a1a1a1;
}
.towerTag {
  font-size: 14px;
  color: #828282;
  text-shadow: 0px 0px 1px rgba(128, 128, 128, 0.7);
  position:absolute;right:10px;bottom:10px;
}
.towerInfo {
  font-size: 12px;
  background-color:rgba(240, 240, 240, 0.6);
  position: absolute;
  top: 35px;
  left: 0;
  bottom: 26px;
  right: 0;
  overflow: auto;
  padding: 2px 5px;
}

.towerAuthString{
  font-size: 0.65em;
  position: absolute;
  left: 0;
  bottom: 26px;
}

.towerTab {color:black;}
.towerTab > *{margin:5px 10px;}
.towerTab > :first-child{margin-top:10px;}
.towerTab > :last-child{margin-bottom:10px;}

</style>
</head>
<body><pre id="mobilecss" style="display: none;">

</pre>
<!-- css END -->
<script src="/urlmap.js"></script>
<script type="text/javascript">
/*
  var twidth = 345;
  var ratio = 1.25/(window.devicePixelRatio || 1);
  if (ratio>1.0001) {
    twidth=~~(twidth*ratio);
  }
  isMobile=0;
  if(navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)){
    isMobile=1;
  }
  if(isMobile){
     var cssNode=document.createElement("style");
    cssNode.innerHTML=mobilecss.innerText;
    document.head.appendChild(cssNode); 
    //document.head.innerHTML+='<style>'+mobilecss.innerText+'</style>';
    var wt = 2;//~~(innerWidth/twidth);
    twidth=~~(innerWidth/wt)-20;
  }
  var theight = ~~(twidth*193/324);
  var cssNode=document.createElement("style");
  cssNode.innerHTML=['.towerTab {',
    'height: ',theight,'px;','width: ',twidth,
    'px;','}\n'
  ].join('');
  document.head.appendChild(cssNode);*/
</script>
<canvas id="background"></canvas>
<script>
(function(){
  //背景
  var background = document.getElementById('background');
  var resize = function(){
    
    var ratio = window.devicePixelRatio || 1;
    var dc=background.getContext('2d');
    
    background.width = innerWidth*ratio;
    background.height = innerHeight*ratio;
    dc.scale(ratio, ratio);

    var bsize=32;
    var fullWidth=~~((innerWidth-17)*ratio);
    var fullHeight=~~(innerHeight*ratio);
    
    var fullX=~~(fullWidth/bsize)-1;
    var fullY=~~(fullHeight/bsize)-1;

    var colorA=["#f9f9f9","#fdfdfd"];
    var colorIndex =1;
    for(ii=0;ii<=fullX+1;ii++){
      colorIndex=ii%2;
      for(jj=0;jj<=fullY+1;jj++){
        dc.fillStyle=colorA[colorIndex];
        if(Math.random()<0.03)dc.fillStyle='#'+'ef'[~~(Math.random()*2)]+''+'ef'[~~(Math.random()*2)]+''+'ef'[~~(Math.random()*2)];
        colorIndex=1-colorIndex;
        dc.fillRect(ii*bsize,jj*bsize,bsize,bsize);
      }
    }
  };
  resize();
  window.onresize = resize;
})();
</script>

<div class='Container'>

<div class='main'>
  <div id='towers'>
    <!-- <div class="towerTab" id="pageinfo">
      <p>HTML5魔塔交流群 : 539113091</p>
      <div class="towerInfo">
          <select style="margin:0" id='sortTowerSelect'>
              <option value="default">按[难度+tag]排序</option>
              <option value="difficulty">按难度排序</option>
              <option value="time">按发布时间排序</option>
              <option value="popularity">按人气排序</option>
            </select>
        <p>页面搭建中,更多功能有待添加,欢迎在<a href="https://github.com/ckcz123/mota-js/issues/22">issues/22</a>中提建议</p>
      
        <p><a href="https://github.com/ckcz123/mota-js">开源项目地址</a></p>
        <p><a href="https://ckcz123.com/games/template/">Demo / 样板效果</a></p>
      
        <p><a href="http://www.bilibili.com/video/av17608025/">Video / 视频教程</a></p>
        <p><a href="https://ckcz123.github.io/mota-js">Docs / 使用文档说明</a></p>
      </div>
    </div> -->
  </div>
  <!-- <a href="#"><div class="towerTab"><p>aaa</p></div></a> -->
</div>

<!-- ============ -->
<br style="clear:both"><br>
<select style="margin:0" id='sortTowerSelect'>
  <option value="default">按[难度+tag]排序</option>
  <option value="maxTime">按max达成时间排序</option>
  <option value="difficulty">按难度排序</option>
  <option value="time">按发布时间排序</option>
  <option value="popularity">按人气排序</option>
  <option value="首发">筛选[首发]tag</option>
</select>
<span>倒序</span>
<input type="checkbox" id='order'>
<span>查找</span>
<input type="text" id='findTowerInput' placeholder="输入查找的字符串">
<hr>
<div style='margin:10px'>
  <p>HTML5魔塔交流群 : 539113091</p>
  <p>页面搭建中,更多功能有待添加,欢迎在<a href="https://github.com/ckcz123/mota-js/issues/22">issues/22</a>中提建议</p>

  <p><a href="https://ckcz123.com/games/_client/H5mota.apk">安卓APP下载</a></p>

  <p><a href="https://github.com/ckcz123/mota-js">开源项目地址</a></p>
  <p><a href="https://ckcz123.com/games/template/">Demo / 样板效果</a></p>

  <p><a href="http://www.bilibili.com/video/av17608025/">Video / 视频教程</a></p>
  <p><a href="https://ckcz123.github.io/mota-js">Docs / 使用文档说明</a></p>

  <p><a href="https://tieba.baidu.com/f?ie=utf-8&kw=%E9%AD%94%E5%A1%94">友情链接 : 魔塔吧</a></p>

  <br>
  <p>max持有数</p>
  <p id='maxNumPrint'></p>

</div>

</div>
<script>
(function(){  
  //<!-- urlmap START -->

  //<!-- urlmap END -->
  for(var id in urlmap){
    urlmap[id].sortIndex={}
    urlmap[id].sortIndex.default=0;
  }
  //添加到<ul/>中
  var towerIdToHTML = function(towerId) {
    var special = '',_special='';
    if (urlmap[towerId].authString){
      special = urlmap[towerId].authString;
      _special = ' style="bottom: 50px;"';
    }
    var tags = [];
    if (urlmap[towerId].tag){
      tags.push(Array(3).join('&nbsp;')+'<span class="towerTag">')
      for (var ii=0,tag;tag=urlmap[towerId].tag[ii];ii++){
        for (var name in tag){//其实就一组键值对
          tags.push('&nbsp;&nbsp;'+name);
          urlmap[towerId].sortIndex.default+=tag[name];
        }
      }
      tags.push('</span>')
    }
    urlmap[towerId].auth = urlmap[towerId].auth||'unknow';
    urlmap[towerId].auth2 = urlmap[towerId].auth2||urlmap[towerId].auth;
    var auth = Array(3).join('&nbsp;')+'<span class="towerAuths"><span class="towerAuth">'+urlmap[towerId].auth+'</span>';
    if(urlmap[towerId].auth!==urlmap[towerId].auth2)auth+='<span class="towerAuth2">/'+urlmap[towerId].auth2+'</span>';
    auth+='</span>';
    return [
      '<div class="towerTab" id="towerId_',towerId,'" onclick="window.open(\'',urlmap[towerId].long,'\', \'_blank\')"><p>',
      urlmap[towerId].short[0],auth,tags.join(''),
      '</p><p class="towerInfo"',_special,'></p>',
      special,'</div>',
      '\n'
    ].join('');
  }

  var towersHTML='\n';
  Object.keys(urlmap).sort(function(a,b){return -(urlmap[a].short[2].slice(1)-urlmap[b].short[2].slice(1))}).forEach(function(towerId){
    towersHTML+= towerIdToHTML(towerId);
  });
  document.getElementById("towers").innerHTML += towersHTML;
  for(var id in urlmap){
    urlmap[id].node=document.getElementById("towerId_"+id);
    urlmap[id].sortIndex.time=urlmap[id].short[2].slice(1);
    
  }

})();
</script>

<script>
var maxNum={};
var loadedNum =0;
function finishCallback(){
  loadedNum+=1;
  if(loadedNum==Object.keys(urlmap).length){
    for(var id in urlmap){
      urlmap[id].sortIndex.default+=urlmap[id].sortIndex.difficulty;
    }
    sortTower('default');
    maxNumPrint = document.getElementById('maxNumPrint');
    Object.keys(maxNum).sort(function(a,b){return -(maxNum[a]-maxNum[b])}).forEach(function(username){
      maxNumPrint.innerText+=username+' : '+maxNum[username]+'\n'
    });
  }
}
queryOneTower = function(towerId) {
  var m_core={'firstData':{}};
  m_core.firstData.name=towerId;
  //m_core.firstData.version="Ver 1.3.2"
  m_core.firstData.version="";
  var pdiv=document.getElementById('towerId_'+towerId).children[1];

  m_core.drawText= function(text){
    pdiv.innerText+=''+text;
  }
  m_core.isset = function(a) {
    if (a == undefined || a == null) {
      return false;
    }
    return true;
  }
  m_core.setTwoDigits = function (x) {
    return parseInt(x)<10?"0"+x:x;
  }
  m_core.formatDate = function(date) {
    if (!m_core.isset(date)) return "";
    return date.getFullYear()+"-"+m_core.setTwoDigits(date.getMonth()+1)+"-"+m_core.setTwoDigits(date.getDate())+" "
        +m_core.setTwoDigits(date.getHours())+":"+m_core.setTwoDigits(date.getMinutes())+":"+m_core.setTwoDigits(date.getSeconds());
  }

  //====
  var formData = new FormData();
  formData.append('type', 'statistics');
  formData.append('name', m_core.firstData.name);
  formData.append('version', m_core.firstData.version);

  var xhr = new XMLHttpRequest();
  xhr.open("POST", "https://ckcz123.com/games/upload.php");

  xhr.onload = function(e) {
    if (xhr.status==200) {
      var response = JSON.parse(xhr.response);
      urlmap[towerId].response = response;
      if (response.code<0) {
        m_core.drawText("出错啦！\n无法拉取统计信息。\n错误原因："+response.msg);
        urlmap[towerId].sortIndex.popularity=0;
        urlmap[towerId].sortIndex.difficulty=0;
        urlmap[towerId].sortIndex.maxTime=0;
      }
      else {
        //var text = "\t[本塔统计信息]";
        var text="";
        var toAdd=false;
        urlmap[towerId].sortIndex.popularity=0;
        if (response.data.length==0){
          m_core.drawText('无统计信息');
          urlmap[towerId].sortIndex.difficulty=0;
          urlmap[towerId].sortIndex.maxTime=0;
        }
        response.data.forEach(function (t) {
          if (toAdd) text+="\n\n";
          toAdd=true;
          if (t.hard!='') text+=t.hard+"难度： "
          text+="已有"+t.people+"("+t.peopleip+")人次游戏，"+t.score+"("+t.scoreip+")人次通关。";
          t.info.forEach(function(ending) {
            if (ending.ending!='') {
              text+="\n"+ending.ending+"： 已有"+ending.score+"("+ending.scoreip+")人次通关。";
            }
            if (m_core.isset(ending.max) && ending.max>0) {
              text+="\n当前MAX为"+ending.max+"，最早由 "+(ending.username||"匿名")+" 于"+m_core.formatDate(new Date(1000*ending.timestamp))+"打出。";
              var username=ending.username||"匿名";
              maxNum[username]=(maxNum[username]||0)+1;
              urlmap[towerId].sortIndex.maxTime=1000*ending.timestamp;
            }
          })
          if(t.score==0){
            urlmap[towerId].sortIndex.difficulty=10000+parseInt(t.people);
            urlmap[towerId].sortIndex.maxTime=2345678901234+parseInt(t.people);
          } else {
            var difficulty = function(p,s){
              return p/s+10000/(Math.pow(s+1,5))
            }
            urlmap[towerId].sortIndex.difficulty=difficulty(parseInt(t.peopleip),parseInt(t.scoreip));
            
          }
          urlmap[towerId].sortIndex.popularity+=parseInt(t.people);
        })
        m_core.drawText(text);
      }
    }
    else {
      m_core.drawText("出错啦！\n无法拉取统计信息。\n错误原因：HTTP "+xhr.status);
      urlmap[towerId].sortIndex.popularity=0;
      urlmap[towerId].sortIndex.difficulty=0;
      urlmap[towerId].sortIndex.maxTime=0;
    }
    finishCallback();
  };
  xhr.ontimeout = function() {
    m_core.drawText("出错啦！\n无法拉取统计信息。\n错误原因：Timeout");
    urlmap[towerId].sortIndex.popularity=0;
    urlmap[towerId].sortIndex.difficulty=0;
    urlmap[towerId].sortIndex.maxTime=0;
    finishCallback();
  }
  xhr.onerror = function() {
    m_core.drawText("出错啦！\n无法拉取统计信息。\n错误原因：XHR Error");
    urlmap[towerId].sortIndex.popularity=0;
    urlmap[towerId].sortIndex.difficulty=0;
    urlmap[towerId].sortIndex.maxTime=0;
    finishCallback();
  }
  xhr.send(formData);
  //====
}
Object.keys(urlmap).forEach(function(towerId){
  queryOneTower(towerId);
});

//time,difficulty,popularity
towers=document.getElementById("towers");
order=document.getElementById("order");
function sortTower(index) {
  var tags={'首发':true}
  if(tags[index]){
    showTowerByTag(index);
    return;
  }
  
  Object.keys(urlmap).sort(function(a,b){return (order.checked?1:-1)*(urlmap[a].sortIndex[index]-urlmap[b].sortIndex[index])}).forEach(function(towerId){
    var node=urlmap[towerId].node;
    node.style.display='';
    towers.removeChild(node);
    towers.appendChild(node);
  });
}
function showTowerByTag(index) {
  for(towerId in urlmap){
    var tag = urlmap[towerId].tag||[{}];
    var show_ = (function(){
      for(var tag_ in tag){
        if(typeof(tag[tag_][index])!==typeof(undefined))return true
      }
    })();
    if(show_){
      urlmap[towerId].node.style.display='';
    } else {
      urlmap[towerId].node.style.display='none';
    }
  }
}
document.getElementById("sortTowerSelect").onchange = order.onchange = function(){
  sortTower(document.getElementById("sortTowerSelect").value);
}
findTowerInput=document.getElementById("findTowerInput")
findTowerInput.onchange = function(){
  for(towerId in urlmap){
    var show_ = urlmap[towerId].node.innerText.indexOf(findTowerInput.value)!==-1
    if(show_){
      urlmap[towerId].node.style.display='';
    } else {
      urlmap[towerId].node.style.display='none';
    }
  }
}

</script>


</body>

</html>
